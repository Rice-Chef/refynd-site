<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReFynd Admin ‚Äî Moderation</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0A0A0A; --surface: #141414; --surface-2: #1C1C1C; --surface-3: #222;
      --border: #2A2A2A; --border-2: #383838;
      --accent: #A3896B; --accent-dim: rgba(163,137,107,0.15); --accent-mid: rgba(163,137,107,0.3);
      --red: #FF3B30; --red-dim: rgba(255,59,48,0.12);
      --green: #22C55E; --green-dim: rgba(34,197,94,0.12);
      --yellow: #F59E0B; --yellow-dim: rgba(245,158,11,0.12);
      --blue: #3B82F6; --blue-dim: rgba(59,130,246,0.12);
      --text: #E8E8E8; --text-2: #888; --text-3: #555;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
    .auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 16px; }
    .auth-screen h1 { font-size: 13px; letter-spacing: 6px; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
    .auth-screen p { color: var(--text-2); font-size: 14px; }
    .auth-screen input { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 12px 20px; border-radius: 8px; font-family: 'DM Sans'; font-size: 14px; width: 300px; outline: none; }
    .auth-screen input:focus { border-color: var(--accent); }
    .pw-wrap { position: relative; width: 300px; }
    .pw-wrap input { width: 100%; padding-right: 50px; }
    .pw-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-3); font-size: 12px; user-select: none; }
    .auth-btn { background: var(--accent); color: #000; border: none; padding: 12px 32px; border-radius: 8px; font-family: 'DM Sans'; font-weight: 700; font-size: 13px; cursor: pointer; letter-spacing: 1px; margin-top: 4px; width: 300px; }
    .auth-btn:hover { opacity: 0.9; }
    .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .auth-error { color: var(--red); font-size: 13px; max-width: 300px; text-align: center; }
    .totp-input { font-family: 'DM Mono', monospace !important; font-size: 24px !important; letter-spacing: 12px; text-align: center !important; }
    .lock-icon { font-size: 40px; margin-bottom: 8px; }
    #dashboard { display: none; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 16px 28px; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .logo { font-size: 12px; letter-spacing: 6px; text-transform: uppercase; color: var(--accent); font-weight: 700; }
    .badge { font-family: 'DM Mono', monospace; font-size: 10px; padding: 4px 10px; border-radius: 4px; font-weight: 500; }
    .badge.pending { background: var(--yellow-dim); color: var(--yellow); }
    .badge.resolved { background: var(--green-dim); color: var(--green); }
    .main { display: flex; min-height: calc(100vh - 57px); }
    .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px 0; flex-shrink: 0; }
    .sidebar-section { padding: 0 16px; margin-bottom: 24px; }
    .sidebar-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-3); margin-bottom: 10px; font-weight: 500; padding-left: 8px; }
    .sidebar-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; cursor: pointer; font-size: 13px; color: var(--text-2); border-radius: 8px; margin-bottom: 2px; transition: all 0.15s; }
    .sidebar-item:hover { background: var(--surface-2); color: var(--text); }
    .sidebar-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .sidebar-count { font-family: 'DM Mono', monospace; font-size: 11px; padding: 2px 8px; border-radius: 10px; background: var(--surface-2); color: var(--text-3); font-weight: 500; }
    .sidebar-item.active .sidebar-count { background: var(--accent-mid); color: var(--accent); }
    .sidebar-count.urgent { background: var(--red-dim); color: var(--red); }
    .content { flex: 1; padding: 24px 28px; overflow-y: auto; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 18px; }
    .stat-label { font-size: 11px; color: var(--text-3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .stat-value { font-family: 'DM Mono', monospace; font-size: 28px; font-weight: 700; }
    .stat-value.red { color: var(--red); } .stat-value.green { color: var(--green); } .stat-value.yellow { color: var(--yellow); }
    .card-list { display: flex; flex-direction: column; gap: 12px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: border-color 0.2s; }
    .card:hover { border-color: var(--border-2); }
    .card-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid var(--border); }
    .card-header-left { display: flex; align-items: center; gap: 10px; }
    .card-status { font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 600; padding: 3px 10px; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .card-status.flagged { background: var(--yellow-dim); color: var(--yellow); }
    .card-status.pending { background: var(--blue-dim); color: var(--blue); }
    .card-status.rejected { background: var(--red-dim); color: var(--red); }
    .card-status.approved { background: var(--green-dim); color: var(--green); }
    .card-time { font-size: 11px; color: var(--text-3); font-family: 'DM Mono', monospace; }
    .card-body { display: grid; grid-template-columns: 200px 1fr; }
    .card-preview { background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 260px; position: relative; cursor: pointer; overflow: hidden; }
    .card-preview img { width: 100%; height: 100%; object-fit: cover; }
    .play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); transition: opacity 0.2s; }
    .play-overlay.hidden { opacity: 0; pointer-events: none; }
    .play-icon { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.15); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.25); font-size: 16px; }
    .card-details { padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; }
    .detail-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-3); margin-bottom: 4px; }
    .detail-value { font-size: 13px; color: var(--text-2); line-height: 1.5; }
    .detail-value.caption { color: var(--text); font-style: italic; }
    .detail-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .detail-item { flex: 1; min-width: 120px; }
    .tags-row { display: flex; gap: 5px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 3px 9px; border-radius: 4px; background: var(--surface-3); color: var(--text-2); border: 1px solid var(--border); }
    .tag.valid { background: var(--green-dim); color: var(--green); border-color: rgba(34,197,94,0.2); }
    .tag.invalid { background: var(--red-dim); color: var(--red); border-color: rgba(239,68,68,0.2); }
    .labels-row { display: flex; gap: 4px; flex-wrap: wrap; }
    .label-chip { font-family: 'DM Mono', monospace; font-size: 10px; padding: 2px 8px; border-radius: 3px; background: var(--surface-3); color: var(--text-3); }
    .transcript-box { background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; font-size: 12px; color: var(--text-2); line-height: 1.6; font-style: italic; max-height: 60px; overflow-y: auto; }
    .card-actions { display: flex; gap: 8px; padding: 14px 18px; border-top: 1px solid var(--border); justify-content: flex-end; }
    .btn { font-family: 'DM Sans'; font-size: 12px; font-weight: 600; padding: 8px 18px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--surface-2); color: var(--text-2); transition: all 0.15s; }
    .btn:hover { border-color: var(--text-3); color: var(--text); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn.approve { background: var(--green-dim); color: var(--green); border-color: rgba(34,197,94,0.2); }
    .btn.approve:hover { background: var(--green); color: #fff; }
    .btn.reject, .btn.danger { background: var(--red-dim); color: var(--red); border-color: rgba(255,59,48,0.2); }
    .btn.reject:hover, .btn.danger:hover { background: var(--red); color: #fff; }
    .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 12px; }
    .report-card.resolved { opacity: 0.5; }
    .report-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
    .report-meta { display: flex; flex-direction: column; gap: 4px; }
    .report-type { font-family: 'DM Mono', monospace; font-size: 11px; padding: 3px 8px; border-radius: 4px; display: inline-block; width: fit-content; }
    .report-type.video { background: rgba(99,102,241,0.15); color: #818CF8; }
    .report-type.profile { background: rgba(236,72,153,0.15); color: #F472B6; }
    .report-reason { font-size: 15px; font-weight: 600; text-transform: capitalize; margin-top: 4px; }
    .report-time { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-3); }
    .report-body { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .report-field-label { font-size: 10px; color: var(--text-3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
    .report-field-value { font-size: 13px; color: var(--text-2); }
    .report-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
    .empty-state { text-align: center; padding: 80px 0; color: var(--text-3); }
    .empty-state span { font-size: 44px; display: block; margin-bottom: 12px; }
    .loading-state { text-align: center; padding: 60px; color: var(--text-3); }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; z-index: 999; animation: toastIn 0.3s; }
    .toast.success { background: var(--green); color: #fff; }
    .toast.error { background: var(--red); color: #fff; }
    @keyframes toastIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    @media (max-width: 900px) { .sidebar { display: none; } .stats-row { grid-template-columns: repeat(2,1fr); } .card-body { grid-template-columns: 1fr; } .report-body { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="auth-screen" id="login-screen">
  <h1>ReFynd</h1>
  <p>Admin Moderation Dashboard</p>
  <input type="email" id="email" placeholder="Admin email" />
  <div class="pw-wrap">
    <input type="password" id="password" placeholder="Password" onkeydown="if(event.key==='Enter')signIn()" />
    <span class="pw-toggle" onclick="togglePassword()" id="pw-toggle">Show</span>
  </div>
  <button class="auth-btn" onclick="signIn()" id="login-btn">Sign In</button>
  <div class="auth-error" id="login-error"></div>
</div>

<div class="auth-screen" id="totp-screen" style="display:none;">
  <div class="lock-icon">üîê</div>
  <h1>ReFynd</h1>
  <p>Enter your 6-digit authenticator code</p>
  <input type="text" id="totp-code" class="totp-input" maxlength="6" placeholder="000000" autocomplete="off"
    oninput="this.value=this.value.replace(/\D/g,''); if(this.value.length===6) verifyTOTP();"
    onkeydown="if(event.key==='Enter') verifyTOTP();" />
  <button class="auth-btn" onclick="verifyTOTP()" id="totp-btn">Verify</button>
  <div class="auth-error" id="totp-error"></div>
  <p style="color:var(--text-3);font-size:11px;margin-top:8px;cursor:pointer;" onclick="signOutAdmin()">‚Üê Back to sign in</p>
</div>

<div id="dashboard">
  <div class="header">
    <div class="header-left">
      <div class="logo">ReFynd</div>
      <div class="badge pending" id="header-badge">0</div>
    </div>
    <div style="font-size:12px;color:var(--text-3);">
      <span id="admin-email" style="color:var(--text-2)"></span>
      &nbsp;<span style="color:var(--green);font-size:10px;">‚óè 2FA</span>&nbsp;&nbsp;
      <a href="#" onclick="signOutAdmin();return false;" style="color:var(--red);text-decoration:none;font-weight:600;">Sign out</a>
    </div>
  </div>
  <div class="main">
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-label">AI Moderation</div>
        <div class="sidebar-item active" data-view="flagged" onclick="switchView('flagged')">‚ö†Ô∏è Flagged <span class="sidebar-count urgent" id="count-flagged">0</span></div>
        <div class="sidebar-item" data-view="pending" onclick="switchView('pending')">‚è≥ Pending <span class="sidebar-count" id="count-pending">0</span></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">User Reports</div>
        <div class="sidebar-item" data-view="reports-pending" onclick="switchView('reports-pending')">üö© Open <span class="sidebar-count" id="count-reports-pending">0</span></div>
        <div class="sidebar-item" data-view="reports-resolved" onclick="switchView('reports-resolved')">‚úì Resolved <span class="sidebar-count" id="count-reports-resolved">0</span></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">History</div>
        <div class="sidebar-item" data-view="approved" onclick="switchView('approved')">‚úÖ Approved <span class="sidebar-count" id="count-approved">0</span></div>
        <div class="sidebar-item" data-view="rejected" onclick="switchView('rejected')">‚ùå Rejected <span class="sidebar-count" id="count-rejected">0</span></div>
        <div class="sidebar-item" data-view="all" onclick="switchView('all')">üìã All <span class="sidebar-count" id="count-all">0</span></div>
      </div>
    </div>
    <div class="content">
      <div class="stats-row">
        <div class="stat-card"><div class="stat-label">AI Flagged</div><div class="stat-value yellow" id="stat-flagged">0</div></div>
        <div class="stat-card"><div class="stat-label">Open Reports</div><div class="stat-value red" id="stat-reports">0</div></div>
        <div class="stat-card"><div class="stat-label">Approved</div><div class="stat-value green" id="stat-approved">0</div></div>
        <div class="stat-card"><div class="stat-label">Banned</div><div class="stat-value" id="stat-banned" style="color:var(--text-2);">0</div></div>
      </div>
      <div id="cards-container"><div class="loading-state">Loading...</div></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyCBBsEv-FE3WCA9sbC2Ykd5LqB-pqiGgug",authDomain:"refynd2-ed306.firebaseapp.com",projectId:"refynd2-ed306",storageBucket:"refynd2-ed306.firebasestorage.app",messagingSenderId:"839372712066",appId:"1:839372712066:web:fd3320d87002094c1d6c9b"});
const authInstance=firebase.auth(), db=firebase.firestore();
const API='https://europe-west2-refynd2-ed306.cloudfunctions.net';
let allVideos=[],allReports=[],currentView='flagged',totpVerified=false,cachedTOTP=null;

async function getToken(){return authInstance.currentUser.getIdToken();}
async function callAPI(ep,body){
  const h={'Content-Type':'application/json','Authorization':'Bearer '+(await getToken())};
  if(cachedTOTP) h['x-totp-code']=cachedTOTP;
  const r=await fetch(`${API}/${ep}`,{method:'POST',headers:h,body:JSON.stringify(body)});
  const d=await r.json(); if(!r.ok) throw new Error(d.error||'Error'); return d;
}
async function callAPIRaw(ep,body){
  const h={'Content-Type':'application/json','Authorization':'Bearer '+(await getToken())};
  const r=await fetch(`${API}/${ep}`,{method:'POST',headers:h,body:JSON.stringify(body)});
  const d=await r.json(); if(!r.ok) throw new Error(d.error||'Error'); return d;
}
function showToast(m,t='success'){const e=document.createElement('div');e.className=`toast ${t}`;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000);}
function showScreen(s){document.getElementById('login-screen').style.display='none';document.getElementById('totp-screen').style.display='none';document.getElementById('dashboard').style.display='none';if(s==='login')document.getElementById('login-screen').style.display='flex';if(s==='totp'){document.getElementById('totp-screen').style.display='flex';setTimeout(()=>document.getElementById('totp-code').focus(),100);}if(s==='dashboard')document.getElementById('dashboard').style.display='block';}

async function signIn(){
  const email=document.getElementById('email').value.trim(),pw=document.getElementById('password').value,err=document.getElementById('login-error'),btn=document.getElementById('login-btn');
  err.textContent='';btn.disabled=true;btn.textContent='Signing in...';
  try{const c=await authInstance.signInWithEmailAndPassword(email,pw);const t=await c.user.getIdTokenResult();
    if(!t.claims.admin){err.textContent='This account does not have admin access.';await authInstance.signOut();btn.disabled=false;btn.textContent='Sign In';return;}
    showScreen('totp');
  }catch(e){err.textContent=e.message;}
  btn.disabled=false;btn.textContent='Sign In';
}

async function verifyTOTP(){
  const code=document.getElementById('totp-code').value.trim(),err=document.getElementById('totp-error'),btn=document.getElementById('totp-btn');
  err.textContent='';if(code.length!==6){err.textContent='Enter a 6-digit code';return;}
  btn.disabled=true;btn.textContent='Verifying...';
  try{await callAPIRaw('verifyTOTP',{code});cachedTOTP=code;totpVerified=true;document.getElementById('admin-email').textContent=authInstance.currentUser.email;showScreen('dashboard');loadData();}
  catch(e){err.textContent=e.message==='Invalid code'?'Wrong code ‚Äî check your authenticator app':e.message;document.getElementById('totp-code').value='';document.getElementById('totp-code').focus();}
  btn.disabled=false;btn.textContent='Verify';
}

function togglePassword(){const p=document.getElementById('password'),t=document.getElementById('pw-toggle');if(p.type==='password'){p.type='text';t.textContent='Hide';}else{p.type='password';t.textContent='Show';}}
function signOutAdmin(){authInstance.signOut();totpVerified=false;cachedTOTP=null;showScreen('login');}

authInstance.onAuthStateChanged(async u=>{if(u){const t=await u.getIdTokenResult();if(t.claims.admin){if(!totpVerified)showScreen('totp');else showScreen('dashboard');return;}}showScreen('login');});

async function loadData(){await Promise.all([loadVideos(),loadReports(),loadBannedCount()]);updateCounts();renderView();}
async function loadVideos(){try{const s=await db.collection('videos').orderBy('createdAt','desc').get();allVideos=[];for(const d of s.docs){const data=d.data();let pn='Unknown';if(data.userId){try{const p=await db.collection('professionals').doc(data.userId).get();if(p.exists())pn=p.data().name||'Unknown';}catch(e){}}allVideos.push({id:d.id,...data,proName:pn});}}catch(e){console.error(e);}}
async function loadReports(){try{const s=await db.collection('reports').orderBy('createdAt','desc').get();allReports=s.docs.map(d=>({id:d.id,...d.data()}));}catch(e){console.error(e);}}
async function loadBannedCount(){try{const s=await db.collection('bannedUsers').get();document.getElementById('stat-banned').textContent=s.size;}catch(e){}}

function updateCounts(){
  const f=allVideos.filter(v=>v.status==='flagged'),p=allVideos.filter(v=>v.status==='pending'),a=allVideos.filter(v=>v.status==='approved'),r=allVideos.filter(v=>v.status==='rejected'),rp=allReports.filter(r=>r.status!=='resolved'),rr=allReports.filter(r=>r.status==='resolved');
  document.getElementById('stat-flagged').textContent=f.length;document.getElementById('stat-reports').textContent=rp.length;document.getElementById('stat-approved').textContent=a.length;
  document.getElementById('count-flagged').textContent=f.length;document.getElementById('count-pending').textContent=p.length;
  document.getElementById('count-reports-pending').textContent=rp.length;document.getElementById('count-reports-resolved').textContent=rr.length;
  document.getElementById('count-approved').textContent=a.length;document.getElementById('count-rejected').textContent=r.length;document.getElementById('count-all').textContent=allVideos.length;
  const u=f.length+rp.length;document.getElementById('header-badge').textContent=u>0?u+' needs review':'All clear';document.getElementById('header-badge').className=u>0?'badge pending':'badge resolved';
}

function switchView(v){currentView=v;document.querySelectorAll('.sidebar-item').forEach(e=>e.classList.remove('active'));const e=document.querySelector(`.sidebar-item[data-view="${v}"]`);if(e)e.classList.add('active');renderView();}

function renderView(){
  const c=document.getElementById('cards-container');
  if(currentView==='reports-pending'){c.innerHTML=renderReportCards(false);return;}
  if(currentView==='reports-resolved'){c.innerHTML=renderReportCards(true);return;}
  let items=[];
  if(currentView==='flagged')items=allVideos.filter(v=>v.status==='flagged');
  else if(currentView==='pending')items=allVideos.filter(v=>v.status==='pending');
  else if(currentView==='approved')items=allVideos.filter(v=>v.status==='approved');
  else if(currentView==='rejected')items=allVideos.filter(v=>v.status==='rejected');
  else items=allVideos;
  if(items.length===0){const m={flagged:['‚ú®','No flagged content'],pending:['‚è≥','Nothing pending'],approved:['‚úÖ','No approved content'],rejected:['üóëÔ∏è','No rejected content'],all:['üì≠','No content yet']};const[e,msg]=m[currentView]||['üì≠','Nothing here'];c.innerHTML=`<div class="empty-state"><span>${e}</span>${msg}</div>`;return;}
  c.innerHTML='<div class="card-list">'+items.map(renderVideoCard).join('')+'</div>';
}

function renderVideoCard(v){
  const time=v.moderatedAt||v.createdAt||'',timeStr=time?new Date(time).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):'';
  const allTags=(v.categories||v.serviceTags||[]).map(t=>{if((v.validatedCategories||[]).includes(t))return`<span class="tag valid">${t} ‚úì</span>`;if((v.invalidCategories||[]).includes(t))return`<span class="tag invalid">${t} ‚úó</span>`;return`<span class="tag">${t}</span>`;}).join('');
  const labels=(v.moderationLabels||[]).map(l=>`<span class="label-chip">${l}</span>`).join('');
  const hashtags=(v.customHashtags||[]).map(h=>`<span class="tag">#${h}</span>`).join('');
  const isVid=!v.type||v.type!=='slideshow',showAct=v.status==='flagged'||v.status==='pending';
  return`<div class="card"><div class="card-header"><div class="card-header-left"><span class="card-status ${v.status||'pending'}">${v.status||'pending'}</span><span style="font-size:13px;color:var(--text);">${v.proName}</span>${v.contentType?`<span style="font-size:11px;color:var(--text-3);background:var(--surface-3);padding:2px 8px;border-radius:4px;">${v.contentType}</span>`:''}</div><span class="card-time">${timeStr}</span></div><div class="card-body"><div class="card-preview" onclick="toggleVideo(this,'${v.videoUrl||''}')">${v.thumbnailUrl?`<img src="${v.thumbnailUrl}" />`:'<div style="color:var(--text-3)">No preview</div>'}${isVid&&v.videoUrl?'<div class="play-overlay"><div class="play-icon">‚ñ∂</div></div>':''}</div><div class="card-details"><div><div class="detail-label">Caption</div><div class="detail-value caption">${v.caption||'No caption'}</div></div>${v.moderationNote?`<div><div class="detail-label">AI Analysis</div><div class="detail-value" style="font-size:12px;">${v.moderationNote}</div></div>`:''}${v.transcript?`<div><div class="detail-label">Audio Transcript</div><div class="transcript-box">"${v.transcript}"</div></div>`:''}<div class="detail-row"><div class="detail-item"><div class="detail-label">Categories</div><div class="tags-row">${allTags||'<span style="color:var(--text-3);font-size:12px;">None</span>'}</div></div>${hashtags?`<div class="detail-item"><div class="detail-label">Hashtags</div><div class="tags-row">${hashtags}</div></div>`:''}</div>${labels?`<div><div class="detail-label">Vision Labels</div><div class="labels-row">${labels}</div></div>`:''}</div></div>${showAct?`<div class="card-actions"><button class="btn approve" onclick="moderateVideo('${v.id}','approve',this)">‚úì Approve</button><button class="btn reject" onclick="moderateVideo('${v.id}','reject',this)">‚úó Reject</button></div>`:`<div class="card-actions">${v.status==='approved'?`<button class="btn reject" onclick="moderateVideo('${v.id}','reject',this)">Revoke</button>`:''}${v.status==='rejected'?`<button class="btn approve" onclick="moderateVideo('${v.id}','approve',this)">Override ‚Üí Approve</button>`:''}</div>`}</div>`;
}

function renderReportCards(resolved){
  const filtered=resolved?allReports.filter(r=>r.status==='resolved'):allReports.filter(r=>r.status!=='resolved');
  if(filtered.length===0)return`<div class="empty-state"><span>${resolved?'üìã':'‚úÖ'}</span>${resolved?'No resolved reports':'No open reports'}</div>`;
  return filtered.map(r=>{const isR=r.status==='resolved',type=r.type||(r.videoId?'video':'profile'),time=r.createdAt?new Date(r.createdAt).toLocaleString():'',reason=(r.reason||'No reason').replace(/_/g,' ');
  return`<div class="report-card ${isR?'resolved':''}"><div class="report-header"><div class="report-meta"><span class="report-type ${type}">${type}</span><span class="report-reason">${reason}</span></div><div style="text-align:right;">${isR?'<span class="badge resolved">RESOLVED</span>':'<span class="badge pending">PENDING</span>'}<div class="report-time" style="margin-top:4px;">${time}</div></div></div><div class="report-body">${r.videoId?`<div><div class="report-field-label">Video ID</div><div class="report-field-value" style="font-family:'DM Mono';font-size:11px;">${r.videoId}</div></div>`:''}${r.reportedUserId?`<div><div class="report-field-label">Reported User</div><div class="report-field-value">${r.reportedName||r.reportedUserId}</div></div>`:''}<div><div class="report-field-label">Reported By</div><div class="report-field-value" style="font-family:'DM Mono';font-size:11px;">${r.reportedBy||'Unknown'}</div></div>${r.resolvedAction?`<div><div class="report-field-label">Action Taken</div><div class="report-field-value" style="text-transform:capitalize;">${r.resolvedAction.replace(/_/g,' ')}</div></div>`:''}</div>${!isR?`<div class="report-actions">${r.videoId?`<button class="btn danger" onclick="removeVideo('${r.id}','${r.videoId}',this)">üóëÔ∏è Remove</button>`:''}${r.reportedUserId?`<button class="btn danger" onclick="banUser('${r.id}','${r.reportedUserId}','${(r.reportedName||'').replace(/'/g,"\\'")}',this)">üö´ Ban</button>`:''}<button class="btn" onclick="warnUser('${r.id}','${r.reportedUserId||r.videoId}',this)">‚ö†Ô∏è Warn</button><button class="btn approve" onclick="dismissReport('${r.id}',this)">‚úì Dismiss</button></div>`:''}</div>`;}).join('');
}

async function moderateVideo(id,action,btn){if(!confirm(action==='approve'?'Approve?':'Reject?'))return;if(btn)btn.disabled=true;try{await callAPI('moderateVideo',{videoId:id,action,reason:'Admin dashboard'});showToast(action==='approve'?'Approved':'Rejected');await loadData();}catch(e){showToast(e.message,'error');if(btn)btn.disabled=false;}}
async function removeVideo(rid,vid,btn){if(!confirm('Remove permanently?'))return;if(btn)btn.disabled=true;try{await callAPI('adminAction',{action:'remove_video',reportId:rid,videoId:vid});showToast('Removed');await loadData();}catch(e){showToast(e.message,'error');if(btn)btn.disabled=false;}}
async function banUser(rid,uid,name,btn){if(!confirm(`Ban ${name||uid}?`))return;if(btn)btn.disabled=true;try{await callAPI('adminAction',{action:'ban_user',reportId:rid,userId:uid,userName:name});showToast('Banned');await loadData();}catch(e){showToast(e.message,'error');if(btn)btn.disabled=false;}}
async function warnUser(rid,tid,btn){const m=prompt('Warning message:');if(!m)return;if(btn)btn.disabled=true;try{await callAPI('adminAction',{action:'warn_user',reportId:rid,userId:tid,message:m});showToast('Warning sent');await loadData();}catch(e){showToast(e.message,'error');if(btn)btn.disabled=false;}}
async function dismissReport(rid,btn){if(!confirm('Dismiss?'))return;if(btn)btn.disabled=true;try{await callAPI('adminAction',{action:'dismiss_report',reportId:rid});showToast('Dismissed');await loadData();}catch(e){showToast(e.message,'error');if(btn)btn.disabled=false;}}

function toggleVideo(el,url){if(!url)return;const img=el.querySelector('img'),ex=el.querySelector('video'),ov=el.querySelector('.play-overlay');if(ex){if(ex.paused){ex.play();if(ov)ov.classList.add('hidden');}else{ex.pause();if(ov)ov.classList.remove('hidden');}return;}const v=document.createElement('video');v.src=url;v.style.cssText='width:100%;height:100%;object-fit:cover;position:absolute;inset:0;';v.autoplay=true;v.loop=true;v.playsInline=true;if(img)img.style.display='none';el.appendChild(v);if(ov)ov.classList.add('hidden');v.play().catch(()=>{v.muted=true;v.play();});}
</script>
</body>
</html>
